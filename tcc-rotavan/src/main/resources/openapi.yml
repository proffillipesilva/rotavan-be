openapi: 3.0.0
info:
  title: RotaVan API
  description: API para o sistema de gerenciamento de transporte escolar RotaVan.
  version: 1.0.0
servers:
  - url: http://localhost:5000/v1/api
    description: Servidor de desenvolvimento
paths:
  /auth/login:
    post:
      summary: Autentica um usuário
      description: Realiza o login (Responsável ou Motorista) e retorna um token JWT.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login bem-sucedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Credenciais inválidas

  /auth/register/responsavel:
    post:
      summary: Registra um novo Responsável
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Responsável criado com sucesso
        '400':
          description: Requisição inválida

  /auth/register/motorista:
    post:
      summary: Registra um novo Motorista
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MotoristaRegisterRequest'
      responses:
        '201':
          description: Motorista criado com sucesso
        '400':
          description: Requisição inválida

  /auth/register/crianca:
    post:
      summary: Registra uma nova Criança (Dependente)
      description: Registra uma criança vinculada ao Responsável autenticado.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CriancaRegisterDTO'
      responses:
        '201':
          description: Criança registrada com sucesso
        '400':
          description: Requisição inválida
        '401':
          description: Não autorizado (Responsável não logado)

  /users/me:
    get:
      summary: Obtém dados do usuário logado
      description: Retorna os dados do perfil (Responsável ou Motorista) do usuário autenticado.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Dados do perfil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MyUserResponse'
        '401':
          description: Não autorizado

  /users/perfil/foto:
    put:
      summary: Upload da foto de perfil
      description: Faz o upload da foto de perfil para o usuário autenticado.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image:
                  type: string
                  format: binary
      responses:
        '200':
          description: Foto atualizada com sucesso
        '401':
          description: Não autorizado

  # --- NOVO: CAMINHOS DO FLUXO DE SOLICITAÇÃO ---
  /solicitacoes:
    post:
      summary: (PASSO 1) Cria uma nova solicitação de vaga
      description: Um Responsável solicita uma vaga para um Dependente (Criança) com um Motorista.
      security:
        - bearerAuth: [] # Assumindo que o Responsável precisa estar logado
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SolicitacaoRequestDTO'
      responses:
        '201':
          description: Solicitação criada com sucesso (retorna a solicitação com as rotas sugeridas)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Solicitacao'
        '404':
          description: Motorista ou Dependente (Criança) não encontrado.

  /solicitacoes/{id}/rotas:
    get:
      summary: (PASSO 3) Motorista vê as rotas sugeridas
      description: Busca as rotas de sugestão (Ida e Volta) calculadas para uma solicitação pendente.
      security:
        - bearerAuth: [] # Assumindo que o Motorista precisa estar logado
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Lista de rotas sugeridas (pode ser uma, duas ou nenhuma).
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Rota'
        '404':
          description: Solicitação não encontrada.

  /solicitacoes/{id}/decisao:
    patch:
      summary: (PASSO 4) Motorista toma a decisão (Aceitar/Recusar)
      description: Atualiza o status de uma solicitação para 'ACEITO' ou 'RECUSADO'.
      security:
        - bearerAuth: [] # Assumindo que o Motorista precisa estar logado
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DecisaoRequestDTO'
      responses:
        '200':
          description: Solicitação atualizada com sucesso.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Solicitacao'
        '404':
          description: Solicitação não encontrada.
  # --- FIM DOS NOVOS CAMINHOS ---

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    LoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
      required:
        - email
        - password

    LoginResponse:
      type: object
      properties:
        token:
          type: string

    RegisterRequest: # Para Responsável
      type: object
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
        cpf:
          type: string
        telefone:
          type: string
        endereco:
          type: string
      required:
        - name
        - email
        - password
        - cpf
        - endereco

    MotoristaRegisterRequest: # Para Motorista
      type: object
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
        cnh:
          type: string
        telefone:
          type: string
        endereco:
          type: string
        pix:
          type: string
      required:
        - name
        - email
        - password
        - cnh
        - endereco

    CriancaRegisterDTO:
      type: object
      properties:
        nome:
          type: string
        escolaId:
          type: string
          format: uuid
        endereco:
          type: string
        periodo:
          type: string
          enum: [MANHA, TARDE, NOITE]
        tipoServico: # --- CAMPO NOVO ADICIONADO ---
          type: string
          enum: [IDA, VOLTA, IDA_E_VOLTA]
      required:
        - nome
        - escolaId
        - endereco
        - periodo
        - tipoServico # --- CAMPO NOVO ADICIONADO ---

    MyUserResponse: # DTO de resposta para /users/me
      type: object
      properties:
        id:
          type: string
          format: uuid
        nome:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          example: 'MOTORISTA'
        picture:
          type: string
          format: uri
        # Campos específicos do Motorista (opcionais)
        cnh:
          type: string
        pix:
          type: string
        # Campos específicos do Responsável (opcionais)
        cpf:
          type: string
        telefone:
          type: string
        endereco:
          type: string
        criancas: # Lista de crianças do responsável
          type: array
          items:
            $ref: '#/components/schemas/Crianca'

    Crianca: # Schema da entidade Crianca (para /users/me)
      type: object
      properties:
        id:
          type: string
          format: uuid
        nome:
          type: string
        endereco:
          type: string
        periodo:
          type: string
        tipoServico: # --- CAMPO NOVO ADICIONADO ---
          type: string
          enum: [IDA, VOLTA, IDA_E_VOLTA]
        escola:
          $ref: '#/components/schemas/Escola'

    Escola: # Schema da entidade Escola
      type: object
      properties:
        id:
          type: string
          format: uuid
        nome:
          type: string
        endereco:
          type: string

    # --- NOVO: SCHEMAS PARA O FLUXO DE SOLICITAÇÃO ---
    SolicitacaoRequestDTO:
      type: object
      properties:
        motoristaId:
          type: string
          format: uuid
          example: '123e4567-e89b-12d3-a456-426614174001'
        dependenteId:
          type: string
          format: uuid
          example: '123e4567-e89b-12d3-a456-426614174002'
      required:
        - motoristaId
        - dependenteId

    DecisaoRequestDTO:
      type: object
      properties:
        status:
          type: string
          example: 'ACEITO'
      required:
        - status

    Solicitacao:
      type: object
      properties:
        id:
          type: string
          format: uuid
        crianca:
          $ref: '#/components/schemas/Crianca'
        motorista:
          $ref: '#/components/schemas/Motoristas' # Adicionando schema faltante
        status:
          type: string
          example: 'PENDENTE'
        rotasSugeridas:
          type: array
          items:
            $ref: '#/components/schemas/Rota'

    # --- NOVO: SCHEMAS FALTANTES ADICIONADOS PARA REFERÊNCIA ---
    Motoristas: # Schema básico (você pode completar)
      type: object
      properties:
        id:
          type: string
          format: uuid
        cnh:
          type: string
        pix:
          type: string
        user:
          $ref: '#/components/schemas/MyUserResponse' # Reutilizando para dados básicos

    Rota:
      type: object
      properties:
        id:
          type: string
          format: uuid
        nomeRota:
          type: string
          example: 'Sugestão Rota de IDA'
        distanciaKm:
          type: number
          format: double
          example: 18.5
        tempoEstimadoMin:
          type: integer
          example: 40
        pontos:
          type: array
          items:
            $ref: '#/components/schemas/Ponto'

    Ponto:
      type: object
      properties:
        id:
          type: string
          format: uuid
        nomePonto:
          type: string
        latitude:
          type: number
          format: double
        longitude:
          type: number
          format: double
        ordem:
          type: integer